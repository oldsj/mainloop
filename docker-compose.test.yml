# Fast test environment
#
# Usage:
#   make test        # Playwright UI with hot reload (frontend via Vite)
#   make test-run    # CI mode headless (frontend via Vite)
#   make test-e2e    # CI mode with all containers (frontend built)

services:
  frontend-test:
    build:
      context: .
      dockerfile: frontend/Dockerfile
      args:
        - VITE_API_URL=http://localhost:8081
    container_name: mainloop-frontend-test
    ports:
      - 3031:3000
    environment:
      - NODE_ENV=production
    depends_on:
      backend-test:
        condition: service_healthy
    healthcheck:
      test: [CMD, node, -e, "require('http').get('http://localhost:3000', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 3s
      timeout: 5s
      retries: 10
      start_period: 10s
    profiles:
      - ci
  postgres-test:
    image: postgres:16-alpine
    container_name: mainloop-postgres-test
    environment:
      POSTGRES_USER: mainloop
      POSTGRES_PASSWORD: mainloop
      POSTGRES_DB: mainloop
    ports:
      - 5433:5432
    healthcheck:
      test: [CMD-SHELL, pg_isready -U mainloop]
      interval: 2s
      timeout: 5s
      retries: 10

  backend-test:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: mainloop-backend-test
    ports:
      - 8081:8000
    volumes:
      # Mount source for hot reload (no rebuild needed)
      - ./backend/src:/app/src:ro
      - ./models:/models:ro
    environment:
      - PYTHONUNBUFFERED=1
      - DB_HOST=postgres-test
      - DB_PORT=5432
      - DB_NAME=mainloop
      - DB_USER=mainloop
      - DB_PASSWORD=mainloop
      - CLAUDE_AGENT_URL=http://claude-agent-test:8001
      - IS_TEST_ENV=true
      - USE_MOCK_CLAUDE=true
      - USE_MOCK_GITHUB=true
    # No --reload needed - watchexec restarts container on file changes
    command: [uvicorn, mainloop.api:app, --host, 0.0.0.0, --port, '8000']
    depends_on:
      postgres-test:
        condition: service_healthy
    healthcheck:
      test: [CMD, curl, -f, http://localhost:8000/health]
      interval: 3s
      timeout: 5s
      retries: 10
      start_period: 10s
