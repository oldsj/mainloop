apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mainloop

resources:
  - ../../base
  - postgres-statefulset.yaml # Simple Postgres (replaces CloudNativePG)
  - nodeport-services.yaml # NodePort for local access

patches:
  # Patch ConfigMap for local environment
  - path: configmap-patch.yaml
    target:
      kind: ConfigMap
      name: mainloop-config

  # Patch backend deployment for test environment
  - path: backend-patch.yaml
    target:
      kind: Deployment
      name: mainloop-backend

  # Disable HTTPRoutes that don't exist in test (prevent errors)
  # Note: These resources don't exist in base anymore, no patching needed

# Override images to use local Kind-loaded images (no registry)
images:
  - name: ghcr.io/yourusername/mainloop-backend
    newName: mainloop-backend
    newTag: test
  - name: ghcr.io/yourusername/mainloop-frontend
    newName: mainloop-frontend
    newTag: test
  - name: ghcr.io/yourusername/mainloop-agent-controller
    newName: mainloop-agent-controller
    newTag: test
